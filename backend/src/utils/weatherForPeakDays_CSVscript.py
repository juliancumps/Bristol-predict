import pandas as pd
import numpy as np

# Arrow to degree conversion mapping
arrow_to_degrees = {
    '→': 90,      # East
    '←': 270,     # West
    '↑': 0,       # North
    '↓': 180,     # South
    '↗': 45,      # Northeast
    '↖': 315,     # Northwest
    '↘': 135,     # Southeast
    '↙': 225,     # Southwest
}

def circular_mean_degrees(degrees_list):
    """
    Calculate the circular mean of wind directions.
    Handles the circular nature of degrees (0-360).
    """
    if not degrees_list or len(degrees_list) == 0:
        return None
    
    # Convert to radians
    radians = np.radians(degrees_list)
    
    # Calculate mean using vector components
    sin_sum = np.sum(np.sin(radians))
    cos_sum = np.sum(np.cos(radians))
    
    # Calculate mean angle
    mean_radians = np.arctan2(sin_sum, cos_sum)
    mean_degrees = np.degrees(mean_radians)
    
    # Convert to 0-360 range
    if mean_degrees < 0:
        mean_degrees += 360
    
    return round(mean_degrees, 1)

# Manually extracted data from screenshots
weather_data = [
    {
        'date': '2023-07-14',
        'temps': [56, 53, 54, 54, 63, 52, 54, 56, 56, 59, 58, 66, 58, 69, 60, 66, 64, 65, 63, 60, 58, 67],
        'wind_speeds': [5, 6, 3, 3, 5, 6, 5, 0, 3, 5, 6, 3, 7, 6, 3, 7, 9, 10, 3, 6, 6, 8],
        'wind_directions': [90, 90, 225, 90, 90, 90, 225, 0, 225, 90, 90, 90, 225, 90, 90, 225, 225, 225, 90, 90, 90, 225]
    },
    {
        'date': '2023-07-03',
        'temps': [50, 50, 49, 49, 49, 49, 49, 49, 49, 50, 50, 51, 50, 50, 50, 50, 52, 52, 52, 51, 48],
        'wind_speeds': [7, 10, 8, 12, 15, 16, 12, 12, 10, 7, 14, 14, 12, 16, 15, 15, 8, 10, 9, 9, 7],
        'wind_directions': [225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225]
    },
    {
        'date': '2025-07-08',
        'temps': [54, 56, 56, 58, 55, 55, 54, 58, 58, 58, 58, 60, 60, 60, 62, 61, 61, 61, 63, 62, 58, 62, 66, 58],
        'wind_speeds': [5, 5, 8, 9, 5, 6, 5, 0, 6, 0, 6, 6, 6, 6, 7, 6, 3, 3, 7, 3, 7, 3, 5, 7],
        'wind_directions': [90, 45, 225, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 225, 225, 225, 225, 225, 90, 90, 90, 225, 90]
    },
    {
        'date': '2024-07-04',
        'temps': [48, 46, 44, 42, 41, 43, 47, 50, 51, 53, 55, 56, 58, 60, 63, 62, 59, 59, 59, 59, 54],
        'wind_speeds': [0, 6, 5, 7, 0, 5, 6, 0, 3, 6, 8, 7, 9, 12, 9, 10, 8, 0, 0, 6, 0],
        'wind_directions': [0, 225, 225, 90, 0, 90, 225, 0, 90, 90, 90, 225, 90, 90, 90, 90, 90, 0, 0, 90, 0]
    },
    {
        'date': '2025-07-05',
        'temps': [52, 52, 52, 52, 51, 51, 51, 51, 52, 52, 53, 52, 52, 52, 52, 51, 50, 50, 50, 50, 51, 50],
        'wind_speeds': [21, 22, 20, 21, 20, 21, 22, 18, 20, 21, 18, 19, 17, 17, 17, 16, 12, 10, 16, 9, 10, 9],
        'wind_directions': [90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90]
    },
    {
        'date': '2025-07-07',
        'temps': [50, 50, 49, 49, 49, 49, 50, 50, 50, 52, 52, 53, 54, 54, 54, 54, 57, 57, 57, 56, 56, 56, 57, 56],
        'wind_speeds': [3, 3, 3, 0, 0, 3, 5, 0, 0, 6, 6, 6, 7, 6, 3, 3, 7, 3, 7, 3, 5, 7, 6, 0],
        'wind_directions': [90, 90, 90, 0, 0, 90, 90, 0, 0, 90, 90, 90, 225, 225, 225, 225, 225, 90, 90, 90, 225, 90, 90, 0]
    },
    {
        'date': '2023-07-13',
        'temps': [51, 51, 51, 50, 49, 49, 53, 56, 56, 69, 60, 61, 65, 67, 67, 67, 66, 66, 66, 65, 60, 58],
        'wind_speeds': [3, 3, 0, 5, 0, 3, 3, 3, 7, 5, 9, 8, 6, 5, 6, 7, 8, 9, 9, 5, 5, 6],
        'wind_directions': [90, 225, 0, 90, 0, 90, 90, 90, 225, 225, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90]
    },
    {
        'date': '2023-07-01',
        'temps': [50, 50, 50, 50, 50, 50, 50, 51, 51, 51, 51, 50, 50, 52, 52, 52, 52, 51, 51, 48, 48, 48, 48],
        'wind_speeds': [5, 8, 8, 5, 6, 9, 9, 9, 12, 12, 10, 9, 9, 17, 16, 16, 15, 14, 12, 17, 15, 14, 16],
        'wind_directions': [90, 90, 90, 90, 90, 90, 90, 225, 225, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90]
    },
    {
        'date': '2025-06-29',
        'temps': [50, 49, 49, 45, 45, 46, 48, 52, 54, 54, 56, 54, 56, 58, 59, 57, 57, 56, 54, 50],
        'wind_speeds': [0, 3, 5, 5, 3, 7, 5, 0, 5, 8, 8, 6, 7, 7, 8, 8, 5, 3, 6, 3],
        'wind_directions': [0, 90, 225, 90, 90, 90, 90, 0, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90]
    },
    {
        'date': '2024-07-05',
        'temps': [53, 54, 54, 52, 52, 53, 57, 57, 58, 59, 61, 64, 65, 62, 63, 64, 61, 59, 59, 59, 57],
        'wind_speeds': [0, 3, 0, 5, 3, 5, 0, 3, 5, 7, 7, 5, 6, 9, 7, 6, 8, 5, 5, 10, 10],
        'wind_directions': [0, 90, 0, 90, 225, 90, 0, 90, 90, 90, 90, 225, 90, 90, 90, 90, 90, 225, 90, 90, 90]
    },
    {
        'date': '2024-07-10',
        'temps': [50, 50, 49, 49, 50, 50, 50, 50, 50, 51, 51, 52, 52, 53, 52, 53, 52, 51, 51, 51],
        'wind_speeds': [3, 5, 7, 6, 5, 7, 3, 3, 6, 6, 8, 8, 10, 10, 13, 13, 10, 12, 13, 14, 12, 14, 15],
        'wind_directions': [90, 90, 90, 90, 225, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90]
    },
    {
        'date': '2025-06-30',
        'temps': [49, 50, 50, 50, 50, 51, 51, 53, 54, 56, 56, 56, 59, 60, 63, 67, 66, 65, 64, 60, 58, 57, 55],
        'wind_speeds': [5, 7, 3, 3, 0, 0, 3, 3, 5, 7, 8, 7, 9, 10, 14, 12, 10, 10, 10, 7, 6, 6, 0],
        'wind_directions': [90, 90, 90, 225, 0, 0, 90, 225, 90, 90, 90, 90, 90, 90, 225, 225, 225, 90, 90, 90, 90, 90, 0]
    },
    {
        'date': '2023-07-05',
        'temps': [50, 50, 50, 50, 50, 50, 50, 50, 49, 49, 50, 50, 49, 50, 50, 50, 49, 49, 49, 49, 49, 49, 49],
        'wind_speeds': [12, 13, 12, 14, 17, 16, 16, 17, 16, 17, 17, 16, 12, 13, 13, 14, 12, 14, 12, 12, 13, 13, 13],
        'wind_directions': [225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 90, 90, 90, 90, 90, 90, 225, 225, 225, 225]
    },
    {
        'date': '2023-07-02',
        'temps': [49, 49, 49, 49, 49, 49, 49, 49, 50, 50, 50, 50, 52, 50, 50, 51, 52, 52, 53, 53, 51, 52],
        'wind_speeds': [17, 17, 16, 15, 16, 15, 15, 8, 8, 9, 9, 15, 12, 13, 9, 14, 9, 15, 12, 9, 15, 10],
        'wind_directions': [90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90]
    },
    {
        'date': '2025-07-01',
        'temps': [54, 53, 53, 53, 52, 51, 51, 52, 52, 52, 52, 53, 53, 53, 52, 52, 52, 52, 50, 50, 49, 50],
        'wind_speeds': [7, 3, 0, 3, 6, 6, 3, 6, 6, 9, 8, 12, 16, 14, 14, 13, 15, 13, 12, 17, 17, 17, 18, 21],
        'wind_directions': [225, 90, 0, 225, 90, 90, 90, 225, 90, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225, 225]
    },
    {
        'date': '2025-07-04',
        'temps': [51, 51, 51, 51, 51, 51, 51, 51, 52, 53, 53, 53, 53, 53, 54, 54, 53, 53, 52, 51],
        'wind_speeds': [14, 14, 12, 12, 12, 12, 13, 12, 12, 12, 14, 14, 13, 14, 13, 14, 13, 14, 13, 12],
        'wind_directions': [90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90]
    },
    {
        'date': '2023-07-15',
        'temps': [56, 53, 54, 54, 55, 55, 55, 56, 59, 59, 58, 56, 57, 57, 56, 56, 57, 54, 54, 53, 53, 53],
        'wind_speeds': [9, 6, 3, 3, 0, 0, 0, 5, 12, 9, 12, 8, 5, 12, 9, 12, 10, 10, 10, 8, 10, 5],
        'wind_directions': [90, 90, 90, 225, 0, 0, 0, 90, 225, 90, 225, 90, 90, 225, 90, 225, 90, 90, 90, 90, 90, 90]
    },
    {
        'date': '2025-07-02',
        'temps': [49, 49, 49, 49, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 49, 49, 49, 49],
        'wind_speeds': [21, 17, 18, 18, 20, 21, 20, 21, 22, 20, 20, 18, 17, 17, 17, 16, 15, 15, 15, 17],
        'wind_directions': [225, 225, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90]
    },
    {
        'date': '2025-07-09',
        'temps': [62, 60, 48, 47, 47, 50, 51, 52, 52, 63, 53, 53, 53, 52, 52, 52, 61, 61, 51, 51, 51, 51, 51, 51, 51, 51],
        'wind_speeds': [6, 6, 3, 6, 0, 5, 6, 10, 9, 14, 13, 13, 16, 15, 17, 20, 20, 21, 22, 22, 22, 23, 23, 24, 26, 24],
        'wind_directions': [225, 90, 90, 90, 0, 90, 90, 225, 225, 225, 225, 225, 225, 225, 225, 225, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90]
    },
    {
        'date': '2024-07-06',
        'temps': [57, 55, 55, 54, 54, 54, 54, 54, 57, 59, 61, 63, 66, 62, 58, 58, 53, 53, 53, 52],
        'wind_speeds': [9, 8, 7, 10, 10, 6, 0, 3, 14, 9, 7, 9, 9, 13, 10, 7, 7, 5, 0, 7],
        'wind_directions': [90, 90, 90, 90, 90, 90, 0, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 225, 0, 225]
    },
    {
        'date': '2024-07-12',
        'temps': [50, 50, 49, 49, 50, 50, 50, 50, 50, 51, 51, 52, 52, 53, 52, 53, 52, 51, 51, 51],
        'wind_speeds': [3, 5, 7, 6, 5, 7, 3, 3, 6, 6, 8, 8, 10, 10, 13, 13, 10, 12, 13, 14],
        'wind_directions': [90, 90, 90, 90, 225, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90]
    }
]

# Process and calculate averages
processed_data = []

for entry in weather_data:
    date = entry['date']
    temps = entry['temps']
    wind_speeds = entry['wind_speeds']
    wind_directions = entry['wind_directions']
    
    # Calculate averages
    avg_temp = round(np.mean(temps), 1)
    avg_wind_speed = round(np.mean([s for s in wind_speeds if s > 0]), 1)  # Exclude 0 speeds
    avg_wind_dir = circular_mean_degrees(wind_directions)
    
    processed_data.append({
        'date': date,
        'wind_speed_mph': avg_wind_speed,
        'wind_direction_deg': avg_wind_dir,
        'temperature_f': avg_temp,
    })
    
    print(f"\n{date}:")
    print(f"  Avg Temp: {avg_temp}°F")
    print(f"  Avg Wind Speed: {avg_wind_speed} mph")
    print(f"  Avg Wind Direction: {avg_wind_dir}° (n={len([d for d in wind_directions if d])} readings)")

# Create DataFrame
weather_df = pd.DataFrame(processed_data)

print("\n" + "="*80)
print("FINAL WEATHER DATA CSV:")
print("="*80)
print(weather_df.to_string(index=False))

# Save to CSV
csv_path = 'bristol_bay_weather.csv'
weather_df.to_csv(csv_path, index=False)
print(f"\n✓ Saved to: {csv_path}")